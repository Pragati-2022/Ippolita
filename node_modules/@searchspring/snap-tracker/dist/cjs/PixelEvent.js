"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PixelEvent = void 0;
var snap_toolbox_1 = require("@searchspring/snap-toolbox");
var types_1 = require("./types");
var PixelEvent = /** @class */ (function () {
    function PixelEvent(payload) {
        var _this = this;
        var _a, _b, _c;
        this.endpoint = "https://d3cgm8py10hi0z.cloudfront.net/is.gif";
        this.src =
            this.endpoint +
                "?s=".concat(encodeURIComponent(((_b = (_a = payload === null || payload === void 0 ? void 0 : payload.context) === null || _a === void 0 ? void 0 : _a.website) === null || _b === void 0 ? void 0 : _b.trackingCode) || '')) +
                "&u=".concat(encodeURIComponent(((_c = payload === null || payload === void 0 ? void 0 : payload.context) === null || _c === void 0 ? void 0 : _c.userId) || '')) +
                "&ce=".concat(snap_toolbox_1.featureFlags.cookies ? '1' : '0') +
                "&pt=".concat(encodeURIComponent(document.title)) +
                "&v=1" + // version always '1'? or set to snap package version?
                "&x=".concat(Math.floor(Math.random() * 2147483647)) +
                "".concat(window.document.referrer ? "&r=".concat(encodeURIComponent(window.document.referrer)) : '');
        switch (payload.category) {
            case types_1.BeaconCategory.PAGEVIEW:
                this.event = payload.event;
                this.src += '&a=viewItem';
                if (this.event.sku) {
                    this.src += "&sku=".concat(encodeURIComponent(this.event.sku));
                }
                break;
            case types_1.BeaconCategory.CARTVIEW:
                this.event = payload.event;
                this.src += '&a=basket';
                this.event.items.forEach(function (item) {
                    if (item === null || item === void 0 ? void 0 : item.sku) {
                        _this.src += "&item=".concat(encodeURIComponent(item.sku), ";").concat(encodeURIComponent((item === null || item === void 0 ? void 0 : item.qty) || ''), ";").concat(encodeURIComponent((item === null || item === void 0 ? void 0 : item.price) || ''), ";");
                    }
                });
                break;
            case types_1.BeaconCategory.ORDERVIEW:
                var _d = (this.event = payload.event), orderId = _d.orderId, total = _d.total, city = _d.city, state = _d.state, country = _d.country, items = _d.items;
                this.src += "&a=sale";
                if (orderId)
                    this.src += "&orderId=".concat(encodeURIComponent(orderId));
                if (total)
                    this.src += "&total=".concat(encodeURIComponent(total));
                if (city)
                    this.src += "&city=".concat(encodeURIComponent(city));
                if (state)
                    this.src += "&state=".concat(encodeURIComponent(state));
                if (country)
                    this.src += "&country=".concat(encodeURIComponent(country));
                items.forEach(function (item) {
                    if (item === null || item === void 0 ? void 0 : item.sku) {
                        _this.src += "&item=".concat(encodeURIComponent(item.sku), ";").concat(encodeURIComponent((item === null || item === void 0 ? void 0 : item.qty) || ''), ";").concat(encodeURIComponent((item === null || item === void 0 ? void 0 : item.price) || ''), ";");
                    }
                });
                break;
        }
        if (this.src.includes('&a=')) {
            this.img = new Image(1, 1);
            this.img.src = this.src; // setting src immediately invokes a request
        }
    }
    return PixelEvent;
}());
exports.PixelEvent = PixelEvent;
